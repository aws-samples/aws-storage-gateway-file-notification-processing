# AWS CDK application workshop to process AWS Storage Gateway (File Gateway) file upload notifications

Â© 2021 Amazon Web Services, Inc. and its affiliates. All rights reserved. This sample code is made available under the MIT-0 license. See the LICENSE file.

Feedback: Contact atieka@amazon.co.uk, djsearle@amazon.co.uk.

---

# Module 5 - Execute an example data vaulting operation
Two steps are involved in the data vaulting process: 

1. Creating sample data on the File Gateway client.
2. Copying (vaulting) the sample data to the File Gateway file share.

In order to make this process quick and easy, we'll use some scripts provided in the `/var/local/cdkapp-scripts` directory.

## 5.1 Scripts and directories used for data vaulting
The scripts used for simulating a data vaulting operation are located in the `example-scripts` directory in this repository and are suitable for running on a Linux platform using a Bash shell. They have already been copied onto the File Gateway client as part of deploying the `DataVaultingStack`.

The directories below, on the File Gateway client, will be used in the following steps:
* Source data directory: `/mnt/sourcedata`. Directory into which we will generate source data to be used as an example logical dataset to be vaulted. The File Gateway client is pre-configured with a 150GB IO1 EBS volume mounted under this directory. 
* Vault data directory: `/mnt/vaultdata`. Directory mountpoint for the NFS file share exported by the File Gateway, into which we will vault data. We created and mounted this file share in [**Module 4.3**](/modules/MODULE4.md#43-configure-the-cache-and-create-a-file-share).

See the `DataVaultingStack` architecture diagram in [**Module 3.2**](/modules/MODULE3.md#32-data-vaulting-stack) for an illustration of the data vaulting traffic flows.

## 5.2 Generate the sample data
We will use the `generate-test-data.sh` script to create the sample logical dataset. Further options are available to this script, which can be viewed by executing it with the `-h` flag. The data created by this script will become the source of the data vaulting operation itself (**section 5.3** below).

To generate a 100GB sample logical dataset, execute the following command on the File Gateway client (including the `sudo`). This will take between 4-5 minutes to complete:
```console
ssm-user@FileGatewayClient>$ sudo ./generate-test-data.sh -s 100 -b 50 -t /mnt/sourcedata
```

The script uses the `openssl` command to populate files with actual data (pseudo-random bytes), as opposed to simply creating "sparse" files full of zeroes. This provides for a more realistic data copy and upload scenario. Below is a screenshot illustrating an example execution of this script:

![File Gateway client generate sample data](/images/screenshots/file-gateway-client-generate-data.png)

## 5.3 Vault the sample data
The `vault-data-example.sh` script is used to copy (vault) the sample logical dataset we've just created. We will use the script to copy the files and directories just created in `/mnt/sourcedata` to `/mnt/vaultdata`. The script will create a random logical dataset ID and also generate a "manifest" file as per the scheme described in [**Module 1**](/modules/MODULE1.md). The File Gateway will upload data copied to `/mnt/vaultdata` to the Amazon S3 bucket created by the `EventProcessingStack`. Files and directories copied will generate File Gateway upload notifications to be consumed and reconciled by the event processing flow.

Execute the following command on the File Gateway client to perform the copy operation (including the `sudo`). This will take between 7-8 minutes to run:
```console
ssm-user@FileGatewayClient>$ sudo ./vault-data-example.sh -s /mnt/sourcedata -t /mnt/vaultdata
```

The script uses the `xargs` command to copy multiple files and directories in parallel. Below is a screenshot illustrating an example execution of this script:

![File Gateway client vault sample data](/images/screenshots/file-gateway-client-vault-data.png)

We're now ready to observe the actions taken by the event processing flow in response to the file upload notifications generated by the File Gateway.

Move onto [Module 6 - Observe the event processing flow](/modules/MODULE3.md) or return to the [main page](/README.md).